function quickCapture(options){
    // url,delay,callback,type,viewPortSize,setting

    options.delay = options.delay || 0;
    options.type = options.type || 'Png';//Svg,Png,Jpeg
    options.viewPortSize=options.viewPortSize || [1366,768];

    options.setting=options.setting || {};

    options.setting.width= options.setting.width || options.viewPortSize[0];
    options.setting.height= options.setting.height || options.viewPortSize[1];


    var wrapper=document.createElement('div');
    wrapper.style.width=0
    wrapper.style.height=0
    wrapper.style.overflow="hidden";
    document.body.appendChild(wrapper);

    var iframe = document.createElement('iframe');
    iframe.width=options.viewPortSize[0];
    iframe.height=options.viewPortSize[1];
    iframe.src=options.url;
    wrapper.appendChild(iframe);

    // document.getElementById('target').appendChild(iframe);

    iframe.onload = function () {
        var script = iframe.contentWindow.document.createElement('script');
        script.onload = function () {
            setTimeout(function(){
                iframe.contentWindow.domtoimage['to'+options.type](iframe.contentWindow.document.body,options.setting)
                    .then(function (dataUrl) {

                        options.callback(dataUrl);
                        wrapper.remove();

                    })
                    .catch(function (error) {
                        console.error('oops, something went wrong!', error);
                    });
            },options.delay);
        };
        script.src = "data:application/javascript;base64,KGZ1bmN0aW9uIChnbG9iYWwpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICB2YXIgdXRpbCA9IG5ld1V0aWwoKTsKICAgIHZhciBpbmxpbmVyID0gbmV3SW5saW5lcigpOwogICAgdmFyIGZvbnRGYWNlcyA9IG5ld0ZvbnRGYWNlcygpOwogICAgdmFyIGltYWdlcyA9IG5ld0ltYWdlcygpOwoKICAgIC8vIERlZmF1bHQgaW1wbCBvcHRpb25zCiAgICB2YXIgZGVmYXVsdE9wdGlvbnMgPSB7CiAgICAgICAgLy8gRGVmYXVsdCBpcyB0byBmYWlsIG9uIGVycm9yLCBubyBwbGFjZWhvbGRlcgogICAgICAgIGltYWdlUGxhY2Vob2xkZXI6IHVuZGVmaW5lZCwKICAgICAgICAvLyBEZWZhdWx0IGNhY2hlIGJ1c3QgaXMgZmFsc2UsIGl0IHdpbGwgdXNlIHRoZSBjYWNoZQogICAgICAgIGNhY2hlQnVzdDogZmFsc2UKICAgIH07CgogICAgdmFyIGRvbXRvaW1hZ2UgPSB7CiAgICAgICAgdG9Tdmc6IHRvU3ZnLAogICAgICAgIHRvUG5nOiB0b1BuZywKICAgICAgICB0b0pwZWc6IHRvSnBlZywKICAgICAgICB0b0Jsb2I6IHRvQmxvYiwKICAgICAgICB0b1BpeGVsRGF0YTogdG9QaXhlbERhdGEsCiAgICAgICAgaW1wbDogewogICAgICAgICAgICBmb250RmFjZXM6IGZvbnRGYWNlcywKICAgICAgICAgICAgaW1hZ2VzOiBpbWFnZXMsCiAgICAgICAgICAgIHV0aWw6IHV0aWwsCiAgICAgICAgICAgIGlubGluZXI6IGlubGluZXIsCiAgICAgICAgICAgIG9wdGlvbnM6IHt9CiAgICAgICAgfQogICAgfTsKCiAgICBpZiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBkb210b2ltYWdlOwogICAgZWxzZQogICAgICAgIGdsb2JhbC5kb210b2ltYWdlID0gZG9tdG9pbWFnZTsKCgogICAgLyoqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUgLSBUaGUgRE9NIE5vZGUgb2JqZWN0IHRvIHJlbmRlcgogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBSZW5kZXJpbmcgb3B0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gb3B0aW9ucy5maWx0ZXIgLSBTaG91bGQgcmV0dXJuIHRydWUgaWYgcGFzc2VkIG5vZGUgc2hvdWxkIGJlIGluY2x1ZGVkIGluIHRoZSBvdXRwdXQKICAgICAqICAgICAgICAgIChleGNsdWRpbmcgbm9kZSBtZWFucyBleGNsdWRpbmcgaXQncyBjaGlsZHJlbiBhcyB3ZWxsKS4gTm90IGNhbGxlZCBvbiB0aGUgcm9vdCBub2RlLgogICAgICogQHBhcmFtIHtTdHJpbmd9IG9wdGlvbnMuYmdjb2xvciAtIGNvbG9yIGZvciB0aGUgYmFja2dyb3VuZCwgYW55IHZhbGlkIENTUyBjb2xvciB2YWx1ZS4KICAgICAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLndpZHRoIC0gd2lkdGggdG8gYmUgYXBwbGllZCB0byBub2RlIGJlZm9yZSByZW5kZXJpbmcuCiAgICAgKiBAcGFyYW0ge051bWJlcn0gb3B0aW9ucy5oZWlnaHQgLSBoZWlnaHQgdG8gYmUgYXBwbGllZCB0byBub2RlIGJlZm9yZSByZW5kZXJpbmcuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucy5zdHlsZSAtIGFuIG9iamVjdCB3aG9zZSBwcm9wZXJ0aWVzIHRvIGJlIGNvcGllZCB0byBub2RlJ3Mgc3R5bGUgYmVmb3JlIHJlbmRlcmluZy4KICAgICAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLnF1YWxpdHkgLSBhIE51bWJlciBiZXR3ZWVuIDAgYW5kIDEgaW5kaWNhdGluZyBpbWFnZSBxdWFsaXR5IChhcHBsaWNhYmxlIHRvIEpQRUcgb25seSksCiAgICAgICAgICAgICAgICBkZWZhdWx0cyB0byAxLjAuCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5pbWFnZVBsYWNlaG9sZGVyIC0gZGF0YVVSTCB0byB1c2UgYXMgYSBwbGFjZWhvbGRlciBmb3IgZmFpbGVkIGltYWdlcywgZGVmYXVsdCBiZWhhdmlvdXIgaXMgdG8gZmFpbCBmYXN0IG9uIGltYWdlcyB3ZSBjYW4ndCBmZXRjaAogICAgICogQHBhcmFtIHtCb29sZWFufSBvcHRpb25zLmNhY2hlQnVzdCAtIHNldCB0byB0cnVlIHRvIGNhY2hlIGJ1c3QgYnkgYXBwZW5kaW5nIHRoZSB0aW1lIHRvIHRoZSByZXF1ZXN0IHVybAogICAgICogQHJldHVybiB7UHJvbWlzZX0gLSBBIHByb21pc2UgdGhhdCBpcyBmdWxmaWxsZWQgd2l0aCBhIFNWRyBpbWFnZSBkYXRhIFVSTAogICAgICogKi8KICAgIGZ1bmN0aW9uIHRvU3ZnKG5vZGUsIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICBjb3B5T3B0aW9ucyhvcHRpb25zKTsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5vZGUpCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2xvbmVOb2RlKG5vZGUsIG9wdGlvbnMuZmlsdGVyLCB0cnVlKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnRoZW4oZW1iZWRGb250cykKICAgICAgICAgICAgLnRoZW4oaW5saW5lSW1hZ2VzKQogICAgICAgICAgICAudGhlbihhcHBseU9wdGlvbnMpCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VTdmdEYXRhVXJpKGNsb25lLAogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMud2lkdGggfHwgdXRpbC53aWR0aChub2RlKSwKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmhlaWdodCB8fCB1dGlsLmhlaWdodChub2RlKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIGFwcGx5T3B0aW9ucyhjbG9uZSkgewogICAgICAgICAgICBpZiAob3B0aW9ucy5iZ2NvbG9yKSBjbG9uZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBvcHRpb25zLmJnY29sb3I7CgogICAgICAgICAgICBpZiAob3B0aW9ucy53aWR0aCkgY2xvbmUuc3R5bGUud2lkdGggPSBvcHRpb25zLndpZHRoICsgJ3B4JzsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuaGVpZ2h0KSBjbG9uZS5zdHlsZS5oZWlnaHQgPSBvcHRpb25zLmhlaWdodCArICdweCc7CgogICAgICAgICAgICBpZiAob3B0aW9ucy5zdHlsZSkKICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKG9wdGlvbnMuc3R5bGUpLmZvckVhY2goZnVuY3Rpb24gKHByb3BlcnR5KSB7CiAgICAgICAgICAgICAgICAgICAgY2xvbmUuc3R5bGVbcHJvcGVydHldID0gb3B0aW9ucy5zdHlsZVtwcm9wZXJ0eV07CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUgLSBUaGUgRE9NIE5vZGUgb2JqZWN0IHRvIHJlbmRlcgogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBSZW5kZXJpbmcgb3B0aW9ucywgQHNlZSB7QGxpbmsgdG9Tdmd9CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSAtIEEgcHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZCB3aXRoIGEgVWludDhBcnJheSBjb250YWluaW5nIFJHQkEgcGl4ZWwgZGF0YS4KICAgICAqICovCiAgICBmdW5jdGlvbiB0b1BpeGVsRGF0YShub2RlLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIGRyYXcobm9kZSwgb3B0aW9ucyB8fCB7fSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGNhbnZhcykgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpLmdldEltYWdlRGF0YSgKICAgICAgICAgICAgICAgICAgICAwLAogICAgICAgICAgICAgICAgICAgIDAsCiAgICAgICAgICAgICAgICAgICAgdXRpbC53aWR0aChub2RlKSwKICAgICAgICAgICAgICAgICAgICB1dGlsLmhlaWdodChub2RlKQogICAgICAgICAgICAgICAgKS5kYXRhOwogICAgICAgICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZSAtIFRoZSBET00gTm9kZSBvYmplY3QgdG8gcmVuZGVyCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFJlbmRlcmluZyBvcHRpb25zLCBAc2VlIHtAbGluayB0b1N2Z30KICAgICAqIEByZXR1cm4ge1Byb21pc2V9IC0gQSBwcm9taXNlIHRoYXQgaXMgZnVsZmlsbGVkIHdpdGggYSBQTkcgaW1hZ2UgZGF0YSBVUkwKICAgICAqICovCiAgICBmdW5jdGlvbiB0b1BuZyhub2RlLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIGRyYXcobm9kZSwgb3B0aW9ucyB8fCB7fSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGNhbnZhcykgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwoKTsKICAgICAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUgLSBUaGUgRE9NIE5vZGUgb2JqZWN0IHRvIHJlbmRlcgogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBSZW5kZXJpbmcgb3B0aW9ucywgQHNlZSB7QGxpbmsgdG9Tdmd9CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSAtIEEgcHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZCB3aXRoIGEgSlBFRyBpbWFnZSBkYXRhIFVSTAogICAgICogKi8KICAgIGZ1bmN0aW9uIHRvSnBlZyhub2RlLCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgcmV0dXJuIGRyYXcobm9kZSwgb3B0aW9ucykKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGNhbnZhcykgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwoJ2ltYWdlL2pwZWcnLCBvcHRpb25zLnF1YWxpdHkgfHwgMS4wKTsKICAgICAgICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUgLSBUaGUgRE9NIE5vZGUgb2JqZWN0IHRvIHJlbmRlcgogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBSZW5kZXJpbmcgb3B0aW9ucywgQHNlZSB7QGxpbmsgdG9Tdmd9CiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSAtIEEgcHJvbWlzZSB0aGF0IGlzIGZ1bGZpbGxlZCB3aXRoIGEgUE5HIGltYWdlIGJsb2IKICAgICAqICovCiAgICBmdW5jdGlvbiB0b0Jsb2Iobm9kZSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBkcmF3KG5vZGUsIG9wdGlvbnMgfHwge30pCiAgICAgICAgICAgIC50aGVuKHV0aWwuY2FudmFzVG9CbG9iKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjb3B5T3B0aW9ucyhvcHRpb25zKSB7CiAgICAgICAgLy8gQ29weSBvcHRpb25zIHRvIGltcGwgb3B0aW9ucyBmb3IgdXNlIGluIGltcGwKICAgICAgICBpZih0eXBlb2Yob3B0aW9ucy5pbWFnZVBsYWNlaG9sZGVyKSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgZG9tdG9pbWFnZS5pbXBsLm9wdGlvbnMuaW1hZ2VQbGFjZWhvbGRlciA9IGRlZmF1bHRPcHRpb25zLmltYWdlUGxhY2Vob2xkZXI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9tdG9pbWFnZS5pbXBsLm9wdGlvbnMuaW1hZ2VQbGFjZWhvbGRlciA9IG9wdGlvbnMuaW1hZ2VQbGFjZWhvbGRlcjsKICAgICAgICB9CgogICAgICAgIGlmKHR5cGVvZihvcHRpb25zLmNhY2hlQnVzdCkgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIGRvbXRvaW1hZ2UuaW1wbC5vcHRpb25zLmNhY2hlQnVzdCA9IGRlZmF1bHRPcHRpb25zLmNhY2hlQnVzdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb210b2ltYWdlLmltcGwub3B0aW9ucy5jYWNoZUJ1c3QgPSBvcHRpb25zLmNhY2hlQnVzdDsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZHJhdyhkb21Ob2RlLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHRvU3ZnKGRvbU5vZGUsIG9wdGlvbnMpCiAgICAgICAgICAgIC50aGVuKHV0aWwubWFrZUltYWdlKQogICAgICAgICAgICAudGhlbih1dGlsLmRlbGF5KDEwMCkpCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChpbWFnZSkgewogICAgICAgICAgICAgICAgdmFyIGNhbnZhcyA9IG5ld0NhbnZhcyhkb21Ob2RlKTsKICAgICAgICAgICAgICAgIGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpLmRyYXdJbWFnZShpbWFnZSwgMCwgMCk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRHJhdyBzdWNjZXNzISEhJyk7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FudmFzOwogICAgICAgICAgICB9KTsKCiAgICAgICAgZnVuY3Rpb24gbmV3Q2FudmFzKGRvbU5vZGUpIHsKICAgICAgICAgICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICBjYW52YXMud2lkdGggPSBvcHRpb25zLndpZHRoIHx8IHV0aWwud2lkdGgoZG9tTm9kZSk7CiAgICAgICAgICAgIGNhbnZhcy5oZWlnaHQgPSBvcHRpb25zLmhlaWdodCB8fCB1dGlsLmhlaWdodChkb21Ob2RlKTsKCiAgICAgICAgICAgIGlmIChvcHRpb25zLmJnY29sb3IpIHsKICAgICAgICAgICAgICAgIHZhciBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsKICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBvcHRpb25zLmJnY29sb3I7CiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNhbnZhczsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY2xvbmVOb2RlKG5vZGUsIGZpbHRlciwgcm9vdCkgewogICAgICAgIGlmICghcm9vdCAmJiBmaWx0ZXIgJiYgIWZpbHRlcihub2RlKSkgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOwoKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5vZGUpCiAgICAgICAgICAgIC50aGVuKG1ha2VOb2RlQ29weSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGNsb25lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2xvbmVDaGlsZHJlbihub2RlLCBjbG9uZSwgZmlsdGVyKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGNsb25lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0Nsb25lKG5vZGUsIGNsb25lKTsKICAgICAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIG1ha2VOb2RlQ29weShub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlIGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQpIHJldHVybiB1dGlsLm1ha2VJbWFnZShub2RlLnRvRGF0YVVSTCgpKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGUuY2xvbmVOb2RlKGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNsb25lQ2hpbGRyZW4ob3JpZ2luYWwsIGNsb25lLCBmaWx0ZXIpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gb3JpZ2luYWwuY2hpbGROb2RlczsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA9PT0gMCkgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjbG9uZSk7CgogICAgICAgICAgICByZXR1cm4gY2xvbmVDaGlsZHJlbkluT3JkZXIoY2xvbmUsIHV0aWwuYXNBcnJheShjaGlsZHJlbiksIGZpbHRlcikKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNsb25lQ2hpbGRyZW5Jbk9yZGVyKHBhcmVudCwgY2hpbGRyZW4sIGZpbHRlcikgewogICAgICAgICAgICAgICAgdmFyIGRvbmUgPSBQcm9taXNlLnJlc29sdmUoKTsKICAgICAgICAgICAgICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgZG9uZSA9IGRvbmUKICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNsb25lTm9kZShjaGlsZCwgZmlsdGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGNoaWxkQ2xvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZENsb25lKSBwYXJlbnQuYXBwZW5kQ2hpbGQoY2hpbGRDbG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZG9uZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Nsb25lKG9yaWdpbmFsLCBjbG9uZSkgewogICAgICAgICAgICBpZiAoIShjbG9uZSBpbnN0YW5jZW9mIEVsZW1lbnQpKSByZXR1cm4gY2xvbmU7CgogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCkKICAgICAgICAgICAgICAgIC50aGVuKGNsb25lU3R5bGUpCiAgICAgICAgICAgICAgICAudGhlbihjbG9uZVBzZXVkb0VsZW1lbnRzKQogICAgICAgICAgICAgICAgLnRoZW4oY29weVVzZXJJbnB1dCkKICAgICAgICAgICAgICAgIC50aGVuKGZpeFN2ZykKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNsb25lU3R5bGUoKSB7CiAgICAgICAgICAgICAgICBjb3B5U3R5bGUod2luZG93LmdldENvbXB1dGVkU3R5bGUob3JpZ2luYWwpLCBjbG9uZS5zdHlsZSk7CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gY29weVN0eWxlKHNvdXJjZSwgdGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdXJjZS5jc3NUZXh0KSB0YXJnZXQuY3NzVGV4dCA9IHNvdXJjZS5jc3NUZXh0OwogICAgICAgICAgICAgICAgICAgIGVsc2UgY29weVByb3BlcnRpZXMoc291cmNlLCB0YXJnZXQpOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBjb3B5UHJvcGVydGllcyhzb3VyY2UsIHRhcmdldCkgewogICAgICAgICAgICAgICAgICAgICAgICB1dGlsLmFzQXJyYXkoc291cmNlKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuc2V0UHJvcGVydHkoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2UuZ2V0UHJvcGVydHlWYWx1ZShuYW1lKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2UuZ2V0UHJvcGVydHlQcmlvcml0eShuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBjbG9uZVBzZXVkb0VsZW1lbnRzKCkgewogICAgICAgICAgICAgICAgWyc6YmVmb3JlJywgJzphZnRlciddLmZvckVhY2goZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBjbG9uZVBzZXVkb0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjbG9uZVBzZXVkb0VsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKG9yaWdpbmFsLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICB2YXIgY29udGVudCA9IHN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2NvbnRlbnQnKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRlbnQgPT09ICcnIHx8IGNvbnRlbnQgPT09ICdub25lJykgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gdXRpbC51aWQoKTsKICAgICAgICAgICAgICAgICAgICBjbG9uZS5jbGFzc05hbWUgPSBjbG9uZS5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0eWxlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgICAgICAgICAgICAgICAgc3R5bGVFbGVtZW50LmFwcGVuZENoaWxkKGZvcm1hdFBzZXVkb0VsZW1lbnRTdHlsZShjbGFzc05hbWUsIGVsZW1lbnQsIHN0eWxlKSk7CiAgICAgICAgICAgICAgICAgICAgY2xvbmUuYXBwZW5kQ2hpbGQoc3R5bGVFbGVtZW50KTsKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZm9ybWF0UHNldWRvRWxlbWVudFN0eWxlKGNsYXNzTmFtZSwgZWxlbWVudCwgc3R5bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGVjdG9yID0gJy4nICsgY2xhc3NOYW1lICsgJzonICsgZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNzc1RleHQgPSBzdHlsZS5jc3NUZXh0ID8gZm9ybWF0Q3NzVGV4dChzdHlsZSkgOiBmb3JtYXRDc3NQcm9wZXJ0aWVzKHN0eWxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHNlbGVjdG9yICsgJ3snICsgY3NzVGV4dCArICd9Jyk7CgogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBmb3JtYXRDc3NUZXh0KHN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29udGVudCA9IHN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2NvbnRlbnQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHlsZS5jc3NUZXh0ICsgJyBjb250ZW50OiAnICsgY29udGVudCArICc7JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZm9ybWF0Q3NzUHJvcGVydGllcyhzdHlsZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmFzQXJyYXkoc3R5bGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcChmb3JtYXRQcm9wZXJ0eSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuam9pbignOyAnKSArICc7JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBmb3JtYXRQcm9wZXJ0eShuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5hbWUgKyAnOiAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShuYW1lKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChzdHlsZS5nZXRQcm9wZXJ0eVByaW9yaXR5KG5hbWUpID8gJyAhaW1wb3J0YW50JyA6ICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gY29weVVzZXJJbnB1dCgpIHsKICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbCBpbnN0YW5jZW9mIEhUTUxUZXh0QXJlYUVsZW1lbnQpIGNsb25lLmlubmVySFRNTCA9IG9yaWdpbmFsLnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKG9yaWdpbmFsIGluc3RhbmNlb2YgSFRNTElucHV0RWxlbWVudCkgY2xvbmUuc2V0QXR0cmlidXRlKCJ2YWx1ZSIsIG9yaWdpbmFsLnZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZml4U3ZnKCkgewogICAgICAgICAgICAgICAgaWYgKCEoY2xvbmUgaW5zdGFuY2VvZiBTVkdFbGVtZW50KSkgcmV0dXJuOwogICAgICAgICAgICAgICAgY2xvbmUuc2V0QXR0cmlidXRlKCd4bWxucycsICdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycpOwoKICAgICAgICAgICAgICAgIGlmICghKGNsb25lIGluc3RhbmNlb2YgU1ZHUmVjdEVsZW1lbnQpKSByZXR1cm47CiAgICAgICAgICAgICAgICBbJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2goZnVuY3Rpb24gKGF0dHJpYnV0ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGNsb25lLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGUpOwogICAgICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgY2xvbmUuc3R5bGUuc2V0UHJvcGVydHkoYXR0cmlidXRlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBlbWJlZEZvbnRzKG5vZGUpIHsKICAgICAgICByZXR1cm4gZm9udEZhY2VzLnJlc29sdmVBbGwoKQogICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoY3NzVGV4dCkgewogICAgICAgICAgICAgICAgdmFyIHN0eWxlTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKHN0eWxlTm9kZSk7CiAgICAgICAgICAgICAgICBzdHlsZU5vZGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY3NzVGV4dCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGlubGluZUltYWdlcyhub2RlKSB7CiAgICAgICAgcmV0dXJuIGltYWdlcy5pbmxpbmVBbGwobm9kZSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIG1ha2VTdmdEYXRhVXJpKG5vZGUsIHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5vZGUpCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZSgneG1sbnMnLCAnaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBYTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcobm9kZSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC50aGVuKHV0aWwuZXNjYXBlWGh0bWwpCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICh4aHRtbCkgewogICAgICAgICAgICAgICAgcmV0dXJuICc8Zm9yZWlnbk9iamVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIj4nICsgeGh0bWwgKyAnPC9mb3JlaWduT2JqZWN0Pic7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChmb3JlaWduT2JqZWN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJzxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iJyArIHdpZHRoICsgJyIgaGVpZ2h0PSInICsgaGVpZ2h0ICsgJyI+JyArCiAgICAgICAgICAgICAgICAgICAgZm9yZWlnbk9iamVjdCArICc8L3N2Zz4nOwogICAgICAgICAgICB9KQogICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoc3ZnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ2RhdGE6aW1hZ2Uvc3ZnK3htbDtjaGFyc2V0PXV0Zi04LCcgKyBzdmc7CiAgICAgICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIG5ld1V0aWwoKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZXNjYXBlOiBlc2NhcGUsCiAgICAgICAgICAgIHBhcnNlRXh0ZW5zaW9uOiBwYXJzZUV4dGVuc2lvbiwKICAgICAgICAgICAgbWltZVR5cGU6IG1pbWVUeXBlLAogICAgICAgICAgICBkYXRhQXNVcmw6IGRhdGFBc1VybCwKICAgICAgICAgICAgaXNEYXRhVXJsOiBpc0RhdGFVcmwsCiAgICAgICAgICAgIGNhbnZhc1RvQmxvYjogY2FudmFzVG9CbG9iLAogICAgICAgICAgICByZXNvbHZlVXJsOiByZXNvbHZlVXJsLAogICAgICAgICAgICBnZXRBbmRFbmNvZGU6IGdldEFuZEVuY29kZSwKICAgICAgICAgICAgdWlkOiB1aWQoKSwKICAgICAgICAgICAgZGVsYXk6IGRlbGF5LAogICAgICAgICAgICBhc0FycmF5OiBhc0FycmF5LAogICAgICAgICAgICBlc2NhcGVYaHRtbDogZXNjYXBlWGh0bWwsCiAgICAgICAgICAgIG1ha2VJbWFnZTogbWFrZUltYWdlLAogICAgICAgICAgICB3aWR0aDogd2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gbWltZXMoKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIE9ubHkgV09GRiBhbmQgRU9UIG1pbWUgdHlwZXMgZm9yIGZvbnRzIGFyZSAncmVhbCcKICAgICAgICAgICAgICogc2VlIGh0dHA6Ly93d3cuaWFuYS5vcmcvYXNzaWdubWVudHMvbWVkaWEtdHlwZXMvbWVkaWEtdHlwZXMueGh0bWwKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHZhciBXT0ZGID0gJ2FwcGxpY2F0aW9uL2ZvbnQtd29mZic7CiAgICAgICAgICAgIHZhciBKUEVHID0gJ2ltYWdlL2pwZWcnOwoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICd3b2ZmJzogV09GRiwKICAgICAgICAgICAgICAgICd3b2ZmMic6IFdPRkYsCiAgICAgICAgICAgICAgICAndHRmJzogJ2FwcGxpY2F0aW9uL2ZvbnQtdHJ1ZXR5cGUnLAogICAgICAgICAgICAgICAgJ2VvdCc6ICdhcHBsaWNhdGlvbi92bmQubXMtZm9udG9iamVjdCcsCiAgICAgICAgICAgICAgICAncG5nJzogJ2ltYWdlL3BuZycsCiAgICAgICAgICAgICAgICAnanBnJzogSlBFRywKICAgICAgICAgICAgICAgICdqcGVnJzogSlBFRywKICAgICAgICAgICAgICAgICdnaWYnOiAnaW1hZ2UvZ2lmJywKICAgICAgICAgICAgICAgICd0aWZmJzogJ2ltYWdlL3RpZmYnLAogICAgICAgICAgICAgICAgJ3N2Zyc6ICdpbWFnZS9zdmcreG1sJwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcGFyc2VFeHRlbnNpb24odXJsKSB7CiAgICAgICAgICAgIHZhciBtYXRjaCA9IC9cLihbXlwuXC9dKj8pJC9nLmV4ZWModXJsKTsKICAgICAgICAgICAgaWYgKG1hdGNoKSByZXR1cm4gbWF0Y2hbMV07CiAgICAgICAgICAgIGVsc2UgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbWltZVR5cGUodXJsKSB7CiAgICAgICAgICAgIHZhciBleHRlbnNpb24gPSBwYXJzZUV4dGVuc2lvbih1cmwpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiBtaW1lcygpW2V4dGVuc2lvbl0gfHwgJyc7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpc0RhdGFVcmwodXJsKSB7CiAgICAgICAgICAgIHJldHVybiB1cmwuc2VhcmNoKC9eKGRhdGE6KS8pICE9PSAtMTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHRvQmxvYihjYW52YXMpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgICAgICAgICB2YXIgYmluYXJ5U3RyaW5nID0gd2luZG93LmF0b2IoY2FudmFzLnRvRGF0YVVSTCgpLnNwbGl0KCcsJylbMV0pOwogICAgICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGJpbmFyeVN0cmluZy5sZW5ndGg7CiAgICAgICAgICAgICAgICB2YXIgYmluYXJ5QXJyYXkgPSBuZXcgVWludDhBcnJheShsZW5ndGgpOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgYmluYXJ5QXJyYXlbaV0gPSBiaW5hcnlTdHJpbmcuY2hhckNvZGVBdChpKTsKCiAgICAgICAgICAgICAgICByZXNvbHZlKG5ldyBCbG9iKFtiaW5hcnlBcnJheV0sIHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAnaW1hZ2UvcG5nJwogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNhbnZhc1RvQmxvYihjYW52YXMpIHsKICAgICAgICAgICAgaWYgKGNhbnZhcy50b0Jsb2IpCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUpIHsKICAgICAgICAgICAgICAgICAgICBjYW52YXMudG9CbG9iKHJlc29sdmUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gdG9CbG9iKGNhbnZhcyk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZXNvbHZlVXJsKHVybCwgYmFzZVVybCkgewogICAgICAgICAgICB2YXIgZG9jID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KCk7CiAgICAgICAgICAgIHZhciBiYXNlID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICAgICAgICAgICAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoYmFzZSk7CiAgICAgICAgICAgIHZhciBhID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICAgICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgICAgIGJhc2UuaHJlZiA9IGJhc2VVcmw7CiAgICAgICAgICAgIGEuaHJlZiA9IHVybDsKICAgICAgICAgICAgcmV0dXJuIGEuaHJlZjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHVpZCgpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gMDsKCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJ3UnICsgZm91clJhbmRvbUNoYXJzKCkgKyBpbmRleCsrOwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGZvdXJSYW5kb21DaGFycygpIHsKICAgICAgICAgICAgICAgICAgICAvKiBzZWUgaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvNjI0ODcyMi8yNTE5MzczICovCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgnMDAwMCcgKyAoTWF0aC5yYW5kb20oKSAqIE1hdGgucG93KDM2LCA0KSA8PCAwKS50b1N0cmluZygzNikpLnNsaWNlKC00KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG1ha2VJbWFnZSh1cmkpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgIHZhciBpbWFnZSA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgICAgICAgaW1hZ2Uub25sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW1hZ2UpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIC8vIGltYWdlLm9uZXJyb3IgPSByZWplY3Q7CiAgICAgICAgICAgICAgICBpbWFnZS5vbmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2ltYWdlIGxvYWQgZXJyb3I6Jyx1dGlsKTsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCcnKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpbWFnZS5zcmMgPSB1cmk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZ2V0QW5kRW5jb2RlKHVybCkgewogICAgICAgICAgICB2YXIgVElNRU9VVCA9IDMwMDAwOwogICAgICAgICAgICBpZihkb210b2ltYWdlLmltcGwub3B0aW9ucy5jYWNoZUJ1c3QpIHsKICAgICAgICAgICAgICAgIC8vIENhY2hlIGJ5cGFzcyBzbyB3ZSBkb250IGhhdmUgQ09SUyBpc3N1ZXMgd2l0aCBjYWNoZWQgaW1hZ2VzCiAgICAgICAgICAgICAgICAvLyBTb3VyY2U6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL2RvY3MvV2ViL0FQSS9YTUxIdHRwUmVxdWVzdC9Vc2luZ19YTUxIdHRwUmVxdWVzdCNCeXBhc3NpbmdfdGhlX2NhY2hlCiAgICAgICAgICAgICAgICB1cmwgKz0gKCgvXD8vKS50ZXN0KHVybCkgPyAiJiIgOiAiPyIpICsgKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBmYWlsKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoJycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGRvbmU7CiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5vbnRpbWVvdXQgPSB0aW1lb3V0OwogICAgICAgICAgICAgICAgICAgIHJlcXVlc3QucmVzcG9uc2VUeXBlID0gJ2Jsb2InOwogICAgICAgICAgICAgICAgICAgIHJlcXVlc3QudGltZW91dCA9IFRJTUVPVVQ7CiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5vcGVuKCdHRVQnLCB1cmwsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJlcXVlc3Qub25lcnJvciA9ZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBmYWlsKCdyZXNvdXJjZSBmZXRjaCBmYWlsZWQ6ICcgKyB1cmwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5zZW5kKCk7CgogICAgICAgICAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlcjsKICAgICAgICAgICAgICAgICAgICBpZihkb210b2ltYWdlLmltcGwub3B0aW9ucy5pbWFnZVBsYWNlaG9sZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzcGxpdCA9IGRvbXRvaW1hZ2UuaW1wbC5vcHRpb25zLmltYWdlUGxhY2Vob2xkZXIuc3BsaXQoLywvKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoc3BsaXQgJiYgc3BsaXRbMV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyID0gc3BsaXRbMV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9Y2F0Y2ggewogICAgICAgICAgICAgICAgICAgIGZhaWwoJ3Jlc291cmNlIGZldGNoIGZhaWxlZDogJyArIHVybCk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRvbmUoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcXVlc3QucmVhZHlTdGF0ZSAhPT0gNCkgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICBpZiAocmVxdWVzdC5zdGF0dXMgIT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZihwbGFjZWhvbGRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShwbGFjZWhvbGRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsKCdjYW5ub3QgZmV0Y2ggcmVzb3VyY2U6ICcgKyB1cmwgKyAnLCBzdGF0dXM6ICcgKyByZXF1ZXN0LnN0YXR1cyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBlbmNvZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICAgICAgICAgICAgICBlbmNvZGVyLm9ubG9hZGVuZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSBlbmNvZGVyLnJlc3VsdC5zcGxpdCgvLC8pWzFdOwogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGNvbnRlbnQpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgZW5jb2Rlci5yZWFkQXNEYXRhVVJMKHJlcXVlc3QucmVzcG9uc2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHRpbWVvdXQoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYocGxhY2Vob2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShwbGFjZWhvbGRlcik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbCgndGltZW91dCBvZiAnICsgVElNRU9VVCArICdtcyBvY2N1cmVkIHdoaWxlIGZldGNoaW5nIHJlc291cmNlOiAnICsgdXJsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBkYXRhQXNVcmwoY29udGVudCwgdHlwZSkgewogICAgICAgICAgICByZXR1cm4gJ2RhdGE6JyArIHR5cGUgKyAnO2Jhc2U2NCwnICsgY29udGVudDsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGVzY2FwZShzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC8oWy4qKz9eJHt9KCl8XFtcXVwvXFxdKS9nLCAnXFwkMScpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGVsYXkobXMpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChhcmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGFyZyk7CiAgICAgICAgICAgICAgICAgICAgfSwgbXMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBhc0FycmF5KGFycmF5TGlrZSkgewogICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGFycmF5TGlrZS5sZW5ndGg7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIGFycmF5LnB1c2goYXJyYXlMaWtlW2ldKTsKICAgICAgICAgICAgcmV0dXJuIGFycmF5OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZXNjYXBlWGh0bWwoc3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZSgvIy9nLCAnJTIzJykucmVwbGFjZSgvXG4vZywgJyUwQScpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gd2lkdGgobm9kZSkgewogICAgICAgICAgICB2YXIgbGVmdEJvcmRlciA9IHB4KG5vZGUsICdib3JkZXItbGVmdC13aWR0aCcpOwogICAgICAgICAgICB2YXIgcmlnaHRCb3JkZXIgPSBweChub2RlLCAnYm9yZGVyLXJpZ2h0LXdpZHRoJyk7CiAgICAgICAgICAgIHJldHVybiBub2RlLnNjcm9sbFdpZHRoICsgbGVmdEJvcmRlciArIHJpZ2h0Qm9yZGVyOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaGVpZ2h0KG5vZGUpIHsKICAgICAgICAgICAgdmFyIHRvcEJvcmRlciA9IHB4KG5vZGUsICdib3JkZXItdG9wLXdpZHRoJyk7CiAgICAgICAgICAgIHZhciBib3R0b21Cb3JkZXIgPSBweChub2RlLCAnYm9yZGVyLWJvdHRvbS13aWR0aCcpOwogICAgICAgICAgICByZXR1cm4gbm9kZS5zY3JvbGxIZWlnaHQgKyB0b3BCb3JkZXIgKyBib3R0b21Cb3JkZXI7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBweChub2RlLCBzdHlsZVByb3BlcnR5KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKG5vZGUpLmdldFByb3BlcnR5VmFsdWUoc3R5bGVQcm9wZXJ0eSk7CiAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlLnJlcGxhY2UoJ3B4JywgJycpKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbmV3SW5saW5lcigpIHsKICAgICAgICB2YXIgVVJMX1JFR0VYID0gL3VybFwoWyciXT8oW14nIl0rPylbJyJdP1wpL2c7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlubGluZUFsbDogaW5saW5lQWxsLAogICAgICAgICAgICBzaG91bGRQcm9jZXNzOiBzaG91bGRQcm9jZXNzLAogICAgICAgICAgICBpbXBsOiB7CiAgICAgICAgICAgICAgICByZWFkVXJsczogcmVhZFVybHMsCiAgICAgICAgICAgICAgICBpbmxpbmU6IGlubGluZQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUHJvY2VzcyhzdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5zZWFyY2goVVJMX1JFR0VYKSAhPT0gLTE7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiByZWFkVXJscyhzdHJpbmcpIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgICAgICB2YXIgbWF0Y2g7CiAgICAgICAgICAgIHdoaWxlICgobWF0Y2ggPSBVUkxfUkVHRVguZXhlYyhzdHJpbmcpKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobWF0Y2hbMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHQuZmlsdGVyKGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAhdXRpbC5pc0RhdGFVcmwodXJsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpbmxpbmUoc3RyaW5nLCB1cmwsIGJhc2VVcmwsIGdldCkgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHVybCkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYmFzZVVybCA/IHV0aWwucmVzb2x2ZVVybCh1cmwsIGJhc2VVcmwpIDogdXJsOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC50aGVuKGdldCB8fCB1dGlsLmdldEFuZEVuY29kZSkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuZGF0YUFzVXJsKGRhdGEsIHV0aWwubWltZVR5cGUodXJsKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRhdGFVcmwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UodXJsQXNSZWdleCh1cmwpLCAnJDEnICsgZGF0YVVybCArICckMycpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmdW5jdGlvbiB1cmxBc1JlZ2V4KHVybCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJyh1cmxcXChbXCciXT8pKCcgKyB1dGlsLmVzY2FwZSh1cmwpICsgJykoW1wnIl0/XFwpKScsICdnJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlubGluZUFsbChzdHJpbmcsIGJhc2VVcmwsIGdldCkgewogICAgICAgICAgICBpZiAobm90aGluZ1RvSW5saW5lKCkpIHJldHVybiBQcm9taXNlLnJlc29sdmUoc3RyaW5nKTsKCiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc3RyaW5nKQogICAgICAgICAgICAgICAgLnRoZW4ocmVhZFVybHMpCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAodXJscykgewogICAgICAgICAgICAgICAgICAgIHZhciBkb25lID0gUHJvbWlzZS5yZXNvbHZlKHN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgdXJscy5mb3JFYWNoKGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IGRvbmUudGhlbihmdW5jdGlvbiAoc3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5saW5lKHN0cmluZywgdXJsLCBiYXNlVXJsLCBnZXQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG9uZTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZnVuY3Rpb24gbm90aGluZ1RvSW5saW5lKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICFzaG91bGRQcm9jZXNzKHN0cmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbmV3Rm9udEZhY2VzKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc29sdmVBbGw6IHJlc29sdmVBbGwsCiAgICAgICAgICAgIGltcGw6IHsKICAgICAgICAgICAgICAgIHJlYWRBbGw6IHJlYWRBbGwKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVBbGwoKSB7CiAgICAgICAgICAgIHJldHVybiByZWFkQWxsKGRvY3VtZW50KQogICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHdlYkZvbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKAogICAgICAgICAgICAgICAgICAgICAgICB3ZWJGb250cy5tYXAoZnVuY3Rpb24gKHdlYkZvbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3ZWJGb250LnJlc29sdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChjc3NTdHJpbmdzKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNzc1N0cmluZ3Muam9pbignXG4nKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcmVhZEFsbCgpIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1dGlsLmFzQXJyYXkoZG9jdW1lbnQuc3R5bGVTaGVldHMpKQogICAgICAgICAgICAgICAgLnRoZW4oZ2V0Q3NzUnVsZXMpCiAgICAgICAgICAgICAgICAudGhlbihzZWxlY3RXZWJGb250UnVsZXMpCiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAocnVsZXMpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcnVsZXMubWFwKG5ld1dlYkZvbnQpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmdW5jdGlvbiBzZWxlY3RXZWJGb250UnVsZXMoY3NzUnVsZXMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjc3NSdWxlcwogICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKHJ1bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJ1bGUudHlwZSA9PT0gQ1NTUnVsZS5GT05UX0ZBQ0VfUlVMRTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKHJ1bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlubGluZXIuc2hvdWxkUHJvY2VzcyhydWxlLnN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ3NyYycpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q3NzUnVsZXMoc3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgICAgIHZhciBjc3NSdWxlcyA9IFtdOwogICAgICAgICAgICAgICAgc3R5bGVTaGVldHMuZm9yRWFjaChmdW5jdGlvbiAoc2hlZXQpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB1dGlsLmFzQXJyYXkoc2hlZXQuY3NzUnVsZXMgfHwgW10pLmZvckVhY2goY3NzUnVsZXMucHVzaC5iaW5kKGNzc1J1bGVzKSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3Igd2hpbGUgcmVhZGluZyBDU1MgcnVsZXMgZnJvbSAnICsgc2hlZXQuaHJlZiwgZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBjc3NSdWxlczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gbmV3V2ViRm9udCh3ZWJGb250UnVsZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlOiBmdW5jdGlvbiByZXNvbHZlKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYmFzZVVybCA9ICh3ZWJGb250UnVsZS5wYXJlbnRTdHlsZVNoZWV0IHx8IHt9KS5ocmVmOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5saW5lci5pbmxpbmVBbGwod2ViRm9udFJ1bGUuY3NzVGV4dCwgYmFzZVVybCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBzcmM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdlYkZvbnRSdWxlLnN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ3NyYycpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gbmV3SW1hZ2VzKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGlubGluZUFsbDogaW5saW5lQWxsLAogICAgICAgICAgICBpbXBsOiB7CiAgICAgICAgICAgICAgICBuZXdJbWFnZTogbmV3SW1hZ2UKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIG5ld0ltYWdlKGVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGlubGluZTogaW5saW5lCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBmdW5jdGlvbiBpbmxpbmUoZ2V0KSB7CiAgICAgICAgICAgICAgICBpZiAodXRpbC5pc0RhdGFVcmwoZWxlbWVudC5zcmMpKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShlbGVtZW50LnNyYykKICAgICAgICAgICAgICAgICAgICAudGhlbihnZXQgfHwgdXRpbC5nZXRBbmRFbmNvZGUpCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuZGF0YUFzVXJsKGRhdGEsIHV0aWwubWltZVR5cGUoZWxlbWVudC5zcmMpKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChkYXRhVXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9ubG9hZCA9IHJlc29sdmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBlbGVtZW50Lm9uZXJyb3IgPSByZWplY3Q7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignZWxlbWVudCBsb2FkIGVycm9yOicsZGF0YVVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5zcmMgPSBkYXRhVXJsOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaW5saW5lQWxsKG5vZGUpIHsKICAgICAgICAgICAgaWYgKCEobm9kZSBpbnN0YW5jZW9mIEVsZW1lbnQpKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5vZGUpOwoKICAgICAgICAgICAgcmV0dXJuIGlubGluZUJhY2tncm91bmQobm9kZSkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXdJbWFnZShub2RlKS5pbmxpbmUoKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHV0aWwuYXNBcnJheShub2RlLmNoaWxkTm9kZXMpLm1hcChmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5saW5lQWxsKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGlubGluZUJhY2tncm91bmQobm9kZSkgewogICAgICAgICAgICAgICAgdmFyIGJhY2tncm91bmQgPSBub2RlLnN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2JhY2tncm91bmQnKTsKCiAgICAgICAgICAgICAgICBpZiAoIWJhY2tncm91bmQpIHJldHVybiBQcm9taXNlLnJlc29sdmUobm9kZSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGlubGluZXIuaW5saW5lQWxsKGJhY2tncm91bmQpCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGlubGluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHlsZS5zZXRQcm9wZXJ0eSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdiYWNrZ3JvdW5kJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlubGluZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLmdldFByb3BlcnR5UHJpb3JpdHkoJ2JhY2tncm91bmQnKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfSkodGhpcyk7Cg==";
        iframe.contentWindow.document.head.appendChild(script);
    }
}